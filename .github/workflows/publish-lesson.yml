name: Publish Creator Studio Lesson

on:
  issues:
    types: [opened, labeled]

jobs:
  publish-lesson:
    if: contains(github.event.issue.labels.*.name, 'creator-studio-lesson')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Parse lesson data from issue
      id: parse-lesson
      uses: actions/github-script@v7
      with:
        script: |
          console.log('Parsing lesson data from issue #' + context.issue.number);

          const issueBody = context.payload.issue.body;
          console.log('Issue body length:', issueBody.length);

          // Extract JSON block
          const jsonMatch = issueBody.match(/```json\n([\s\S]*?)\n```/);
          if (!jsonMatch) {
            throw new Error('No ```json block found in issue body');
          }

          console.log('Found JSON block, parsing...');
          let lessonData;
          try {
            lessonData = JSON.parse(jsonMatch[1]);
            console.log('JSON parsed successfully');
          } catch (e) {
            throw new Error('Invalid JSON in lesson data: ' + e.message);
          }

          // Extract manifest block (optional)
          const manifestMatch = issueBody.match(/```manifest\n([\s\S]*?)\n```/);
          let manifestData = {};
          if (manifestMatch) {
            try {
              manifestData = JSON.parse(manifestMatch[1]);
              console.log('Manifest parsed successfully');
            } catch (e) {
              console.log('Invalid manifest JSON, will update existing manifest');
              manifestData = {};
            }
          } else {
            console.log('No manifest block found, will update existing manifest');
          }

          // Get lesson metadata
          const lessonTitle = lessonData.title || 'untitled';
          const lessonId = lessonData.id || 'lesson_new';

          console.log('Parsed data:');
          console.log('  Title:', lessonTitle);
          console.log('  Lesson ID:', lessonId);

          // Extract lesson number from lesson ID (e.g., "lesson_05" -> "05")
          const lessonNumber = lessonId.replace(/^lesson_?/, '') || 'new';
          const filename = `lesson_${lessonNumber}.json`;
          const filepath = `lessons/${filename}`;
          console.log('Generated filepath:', filepath);

          // Write files for next steps
          const fs = require('fs');
          fs.writeFileSync('lesson_data.json', JSON.stringify(lessonData, null, 2));
          fs.writeFileSync('manifest_data.json', JSON.stringify(manifestData, null, 2));

          // Set outputs
          core.setOutput('lesson_title', lessonTitle);
          core.setOutput('lesson_id', lessonId);
          core.setOutput('lesson_number', lessonNumber);
          core.setOutput('filename', filename);
          core.setOutput('filepath', filepath);

    - name: Create lessons directory and backup existing lesson
      run: |
        mkdir -p "lessons"

        # Check if lesson file already exists and backup if it does
        if [ -f "${{ steps.parse-lesson.outputs.filepath }}" ]; then
          echo "Existing lesson found, creating backup..."
          cp "${{ steps.parse-lesson.outputs.filepath }}" "lessons/lesson_${{ steps.parse-lesson.outputs.lesson_number }}_previous.json"
          echo "Backup created: lessons/lesson_${{ steps.parse-lesson.outputs.lesson_number }}_previous.json"
        else
          echo "No existing lesson found, proceeding with new lesson creation"
        fi

    - name: Write lesson file
      run: |
        cp lesson_data.json "${{ steps.parse-lesson.outputs.filepath }}"
        echo "Lesson file created at: ${{ steps.parse-lesson.outputs.filepath }}"

        # Show what files we have now
        echo "Current lessons directory contents:"
        ls -la lessons/lesson_*.json || echo "No lesson files found"

    - name: Update manifest
      run: |
        # Update the manifest with new lesson
        if [ -f "lessons/manifest.json" ]; then
          cp lessons/manifest.json manifest_backup.json
        else
          echo '{"version":"1.0","lastUpdated":"","totalLessons":0,"lessons":{}}' > lessons/manifest.json
        fi

        # Use manifest_data.json if provided, otherwise update existing
        if [ -s manifest_data.json ]; then
          cp manifest_data.json lessons/manifest.json
        else
          # Update existing manifest (fallback logic)
          jq --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)" \
             --arg filepath "${{ steps.parse-lesson.outputs.filepath }}" \
             --slurpfile lesson lesson_data.json \
             '.lastUpdated = $timestamp |
              .lessons[$lesson[0].id] = {
                id: $lesson[0].id,
                title: $lesson[0].title,
                domain_id: $lesson[0].domain_id,
                domain_title: $lesson[0].domain_title,
                skill_id: $lesson[0].skill_id,
                skill_title: $lesson[0].skill_title,
                author: $lesson[0].author,
                created_at: $lesson[0].created_at,
                updated_at: $lesson[0].updated_at,
                published_at: $lesson[0].published_at,
                status: $lesson[0].status,
                filepath: $filepath,
                slide_count: ($lesson[0].slides | length),
                learning_objectives_count: ($lesson[0].learning_objectives | length)
              } |
              .totalLessons = (.lessons | length)' lessons/manifest.json > temp_manifest.json
          mv temp_manifest.json lessons/manifest.json
        fi

    - name: Commit and push lesson
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Creator Studio Bot"

        # Add all lesson files (new lesson and backup if it exists)
        git add "${{ steps.parse-lesson.outputs.filepath }}" lessons/manifest.json

        # Add backup file if it exists
        if [ -f "lessons/lesson_${{ steps.parse-lesson.outputs.lesson_number }}_previous.json" ]; then
          git add "lessons/lesson_${{ steps.parse-lesson.outputs.lesson_number }}_previous.json"
          echo "Added backup file to commit"
        fi

        git commit -m "Add/Update lesson: ${{ steps.parse-lesson.outputs.lesson_title }}

        Published via Creator Studio
        Lesson ID: ${{ steps.parse-lesson.outputs.lesson_id }}
        File: ${{ steps.parse-lesson.outputs.filepath }}

        🤖 Generated with Creator Studio

        Co-Authored-By: Creator Studio Bot <action@github.com>"

        git push

    - name: Comment on issue with success
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `✅ **Lesson Published Successfully!**

            **📚 Lesson:** ${{ steps.parse-lesson.outputs.lesson_title }}
            **🆔 Lesson ID:** ${{ steps.parse-lesson.outputs.lesson_id }}
            **📁 Location:** \`${{ steps.parse-lesson.outputs.filepath }}\`
            **🔢 Lesson Number:** ${{ steps.parse-lesson.outputs.lesson_number }}

            The lesson has been added to the repository and is now available to students.

            **📄 Files Created/Updated:**
            - [📝 Lesson File](${{ github.server_url }}/${{ github.repository }}/blob/main/${{ steps.parse-lesson.outputs.filepath }})
            - [📋 Updated Manifest](${{ github.server_url }}/${{ github.repository }}/blob/main/lessons/manifest.json)

            **💾 Backup:** If a previous version existed, it was backed up as \`lesson_${{ steps.parse-lesson.outputs.lesson_number }}_previous.json\``
          });

    - name: Close issue
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.update({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'closed'
          });

    - name: Clean up temporary files
      run: |
        rm -f issue_body.txt lesson_data.json manifest_data.json manifest_backup.json